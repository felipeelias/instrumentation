<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <style type="text/css"><%= asset('c3.min.css') %></style>
<body>
  <div id="chart"></div>
  <script charset="utf-8"><%= asset('d3.min.js') %></script>
  <script charset="utf-8"><%= asset('c3.min.js') %></script>
  <script>
    var chart = c3.generate({
      bindto: '#chart',
      data: {
        x: 'count',
        columns: [
          <%= ["memory"] + (@data.fetch(:datapoints).map(&:last)) %>,
          <%= ["count"] + (0..@data.fetch(:datapoints).size).to_a %>
        ],
      },
      point: {
        show: false
      }
    });

    var socket = new WebSocket("ws://localhost:8080/");
    socket.onmessage = function (event) {
      var data = JSON.parse(event.data)
      var mem = data.map(function(v) { return v[1] });
      var counts = Array.apply(null, Array(data.length)).map(function (_, i) { return i; });

      chart.load({
        columns: [
          ["memory"].concat(mem),
          ["count"].concat(counts)
        ]
      })
    }
  </script>
</body>
